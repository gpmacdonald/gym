# Deployment Guide

This guide covers deploying the Fitness Tracker PWA to various platforms, with a focus on Netlify.

## Prerequisites

Before deploying, ensure:
1. All tests pass: `npm test && npm run test:e2e`
2. Build succeeds: `npm run build`
3. Code is pushed to a Git repository (GitHub, GitLab, Bitbucket)

## Netlify Deployment (Recommended)

Netlify is the recommended deployment platform for this PWA due to its excellent static hosting, automatic HTTPS, and easy configuration.

### Option 1: Deploy via Netlify UI

1. **Create a Netlify Account**
   - Go to [netlify.com](https://netlify.com)
   - Sign up or log in with GitHub

2. **Connect Your Repository**
   - Click "Add new site" > "Import an existing project"
   - Select your Git provider
   - Choose the fitness-tracker repository

3. **Configure Build Settings**
   - Build command: `npm run build`
   - Publish directory: `dist`
   - Node version: 18 (or 20)

4. **Deploy**
   - Click "Deploy site"
   - Netlify will build and deploy automatically

### Option 2: Deploy via Netlify CLI

```bash
# Install Netlify CLI
npm install -g netlify-cli

# Login to Netlify
netlify login

# Build the project
npm run build

# Deploy to a new site
netlify deploy --prod --dir=dist

# Or link to existing site and deploy
netlify link
netlify deploy --prod
```

### Option 3: Drag and Drop

1. Run `npm run build` locally
2. Go to [app.netlify.com/drop](https://app.netlify.com/drop)
3. Drag the `dist` folder to the browser

## Netlify Configuration

Create a `netlify.toml` file in the project root for consistent configuration:

```toml
[build]
  command = "npm run build"
  publish = "dist"

[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200

[build.environment]
  NODE_VERSION = "18"

[[headers]]
  for = "/assets/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/sw.js"
  [headers.values]
    Cache-Control = "public, max-age=0, must-revalidate"

[[headers]]
  for = "/manifest.webmanifest"
  [headers.values]
    Cache-Control = "public, max-age=0, must-revalidate"
```

### Why These Settings Matter

- **Redirects**: The `/*` to `/index.html` redirect enables client-side routing. Without this, refreshing on `/progress` would return 404.

- **Cache Headers**:
  - Static assets (JS, CSS, images) are immutable and cached for 1 year
  - Service worker and manifest need fresh checks to enable PWA updates

## PWA Requirements for Deployment

For the PWA to work correctly in production:

### 1. HTTPS is Required

PWA features like Service Workers require HTTPS. Netlify provides automatic HTTPS with Let's Encrypt certificates.

### 2. Manifest Configuration

The `manifest.webmanifest` should be served with correct content type. Vite and Netlify handle this automatically.

### 3. Service Worker Scope

The service worker is automatically generated by vite-plugin-pwa and will cache all necessary assets.

## Environment Variables

The app doesn't require any environment variables, but you can set them in Netlify if needed:

1. Go to Site Settings > Build & deploy > Environment
2. Add variables as needed

## Custom Domain Setup

1. In Netlify, go to Domain settings
2. Add your custom domain
3. Configure DNS:
   - A record pointing to Netlify's load balancer
   - Or CNAME record to your Netlify subdomain
4. Netlify will automatically provision SSL

## Continuous Deployment

Netlify automatically deploys when you push to the connected branch:

- **Production branch**: `main` or `master` (configurable)
- **Preview deploys**: Every pull request gets a preview URL
- **Branch deploys**: Optionally deploy other branches

## Alternative Platforms

### Vercel

```bash
# Install Vercel CLI
npm i -g vercel

# Deploy
vercel --prod
```

Create `vercel.json`:
```json
{
  "rewrites": [{ "source": "/(.*)", "destination": "/index.html" }]
}
```

### GitHub Pages

1. Add `base` to `vite.config.ts`:
   ```ts
   export default defineConfig({
     base: '/repo-name/',
     // ...
   })
   ```

2. Build and deploy:
   ```bash
   npm run build
   npx gh-pages -d dist
   ```

Note: GitHub Pages doesn't support SPA routing natively. You'll need a 404.html workaround.

### Cloudflare Pages

1. Connect your Git repository
2. Build command: `npm run build`
3. Build output directory: `dist`
4. Cloudflare handles routing automatically for SPAs

## Post-Deployment Checklist

After deploying, verify:

- [ ] Site loads on HTTPS
- [ ] All pages are accessible (try refreshing on /progress, /exercises, /settings)
- [ ] PWA install prompt appears (or instructions for iOS)
- [ ] Service worker is registered (check DevTools > Application)
- [ ] Offline mode works (disconnect network and refresh)
- [ ] Data persists in IndexedDB
- [ ] Export/import functionality works
- [ ] Charts and visualizations render correctly

## Troubleshooting

### "Page not found" on refresh

Ensure your hosting platform is configured for SPA routing (redirecting all routes to index.html).

### PWA not installable

- Verify HTTPS is working
- Check manifest is being served
- Look for errors in DevTools > Application > Manifest

### Service worker not updating

- The SW should auto-update, but users may need to close all tabs
- Check DevTools > Application > Service Workers for update status

### iOS Safari issues

- PWA features are limited on iOS Safari
- "Add to Home Screen" is in the Share menu
- Ensure all API calls have fallbacks for non-secure contexts

## Performance Optimization

The build is already optimized, but for further improvements:

1. **Analyze bundle**: `npm run build -- --report`
2. **Check Lighthouse**: Run audit in Chrome DevTools
3. **Monitor Core Web Vitals**: Use Netlify Analytics or web-vitals library

## Monitoring

Netlify provides:
- Build logs and deploy previews
- Analytics (paid feature)
- Form handling (if needed)
- Function logs (if using serverless functions)

For application monitoring, consider adding:
- Error tracking (Sentry, Bugsnag)
- Analytics (Plausible, Fathom - privacy-focused options)

---

For more help, see:
- [Netlify Docs](https://docs.netlify.com/)
- [Vite Deployment Guide](https://vitejs.dev/guide/static-deploy.html)
- [PWA Documentation](https://web.dev/progressive-web-apps/)
